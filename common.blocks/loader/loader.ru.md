# loader

Блок `loader` служит для загрузки и подключения скриптов по URL.

## Обзор

### Модификаторы блока

| Модификатор | Допустимые значения | Способы использования | Описание |
| ----------- | ------------------- | --------------------- | -------- |
| <a href="#modifiers-type">type</a> | <code>'js'</code>, <code>'bundle'</code> | <code>JS</code> | Позволяет получить по URL и подключить JavaScript-код или бандл. |


### Функции, подключаемые модификаторами блока

| Модификатор | Имя | Тип или возвращаемое значение | Описание |
| ----------- | --- | ----------------------------- | -------- |
| <a href="#modifiers-type-js">type_js</a> | loader(<br><code>{String} id</code>, <br><code>{String} url</code>, <br><code>[{Function} success]</code>, <br><code>[{Function} error]</code>) | - | Загружает и подключает фрагмент JavaScript-кода. |
| <a href="#modifiers-type-bundle">bundle</a> | loader(<br><code>{String} url</code>, <br><code>{Function} success</code>, <br><code>[{Function} error]</code>) | - | 
Загружает и подключает пакет, собранный из CSS и JS-файлов – «бандл». |

### Публичные технологии блока

Блок реализован в технологиях:

* `js`

## Подробности

<a name="modifiers"></a>
### Модификаторы блока

<a name="modifiers-type"></a>
#### Модификатор `type`

Предоставляет набор функций для загрузки и подключение различных типов данных.

Допустимые значения: `'js'`, `'bundle'`. 

Способ использования: `JS`.

В зависимости от значения модификатора `type` блок `loader` позволяет получить по URL и подключить:

* `bundle` – пакет, собранный из CSS и JS-файлов – «бандл».  

<a name="modifiers-type-js"></a>
##### Модификатор `type` в значении `js`)

Загружает и подключает фрагмент JavaScript-кода.

Принимаемые аргументы: 

* `{String}` `url` – URL загружаемого фрагмента JS-кода. Обязательный аргумент.
* [`{Function}` `success`] – callback-функция, выполняемая по завершению загрузки кода.
* [`{Function}` `error`] – callback-функция, выполняемая при ошибке в ходе загрузки кода.

Не имеет возвращаемого значения. 

Например, `loader_type_js` используется в блоке `common.blocks/jquery` библиотеки `bem-core` для загрузки и подключения jQuery:

```js
modules.define(
    'jquery',
    ['loader_type_js', 'jquery__config'],
    function(provide, loader, cfg) {

/* global jQuery */

function doProvide(preserveGlobal) {
    /**
     * @exports
     * @type Function
     */
    provide(preserveGlobal? jQuery : jQuery.noConflict(true));
}

typeof jQuery !== 'undefined'?
    doProvide(true) :
    loader(cfg.url, doProvide);
});
```


При вызове функция производит поиск строки, переданной первым аргументом:

* среди подключенных `url`. В случае успеха, callback (аргумент `success`) немедленно выполняется, и управление возвращается вызывавшей функции;
* среди имен `url`, ожидающих подключения. В случае успеха, callback помещается в очередь, и управление возвращается вызывавшей функции.

Если текущее значение `url` не найдено, создается запись в очереди на подключение.

Затем создается DOM-элемент `script` со всеми нужными свойствами, который добавляется к элементу `head` документа.

По завершению загрузки:

* выполняются все callback из очереди на подключение;
* `url` удаляется из очереди и добавляется к списку подключенных. 

<a name="modifiers-type-bundle`"></a>
##### Модификатор `type` в значении `bundle`)

Загружает и подключает пакет, собранный из CSS и JS-файлов – «бандл».

Принимаемые аргументы: 

* `{String}` `id` – идентификатор бандла. Обязательный аргумент.
* `{String}` `url` – путь до файла бандла в формате URL. Обязательный аргумент.
* `{Function}` `onSuccess` – callback, вызываемая по завершению загрузки бандла. Обязательный аргумент.
* [`{Function}` `onError`] – callback, вызываемая при неудачной загрузке бандла.

Не имеет возвращаемого значения. 

Например:

```js
modules.define('test-bundle-load', ['loader_type_bundle'], function(provide, bundleLoader) {

    provide(function() {
        var onSuccess = function() { console.log('Loaded!'); },
            onError = function() { throw new Error('ups'); };
        bundleLoader(
            'test1',
            'http://mysite.org/test.bundle.js', 
            onSuccess,
            onError
        );
    });
});
```


При инициализации функции создается объект бандлов, с `id` в качестве ключей и массивами callback-функций в значениях, для выполнения:

*  после успешной загрузки бандла;
*  в случае ошибки загрузки.

В случае успешного выполнения, функция создает DOM-элемент `script` со всеми нужными свойствами, который добавляется перед первым дочерним элементом в `head`.

В ходе выполнения, функция устанавливает таймер загрузки на интервал (по умолчанию 8000 миллисекунд) с помощью `setTimeout`.

По истечению указанного интервала вызывается обработчик ошибок. Обработчик:

* очищает таймер загрузки;
* вызывает все callback-функции `onError`;
* удаляет свойство, соответствующее `id`, из объекта бандлов.

###### Статический метод `_loaded`

Функция, подключаемая с модификатором `type_bundle`, обладает статическим методом – `_loaded`. Он используется как вспомогательный после успешной загрузки бандла.

Принимаемые аргументы: 

* `{String}` `id` – идентификатор бандла. Обязательный аргумент.

Не имеет возвращаемого значения. 

В ходе выполнения метод:

* очищает таймер загрузки;
* вызывает загруженный `bundle.js` в глобальном пространстве имен;
* подключает CSS:
    * создается DOM-элемент `style` с нужными свойствами;
    * DOM-элемент помещается перед первым вложенным элементом в `head`;
* выполняет все callback-функции `onSuccess`.
